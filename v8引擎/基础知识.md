## 什么是 V8

V8 是 JavaScript 虚拟机的一种，可以把我们的 JavaScript 程序语言编译成机器语言并执行。虚拟机通过模拟实际计算机的各种功能来实现代码的执行，如 CPU，堆栈，寄存器等。对于 JavaScript 来说，V8 就是它的整个世界。

### 高级代码为什么需要先编译再执行

首先，计算机的 CPU 只能识别机器码并执行，而机器码就是类似“1000100111011000”的二进制指令。为了能够完成复杂的任务，工程师为 CPU 提供了很多的二进制指令来实现功能。二进制指令对于程序员来说很难阅读和记忆，于是将二进制指令集转为了汇编指令集，类似这种：

```
1000100111011000 机器指令
mov ax,bx 汇编指令
```

当然，CPU 也是识别不了汇编指令的，需要汇编编译器编译成机器码执行。

虽然汇编语言对机器码做了一层抽象，但依然复杂且繁琐，主要表现为以下两点：

- 不同的 CPU 有着不同的指令集；
  ![v8执行js流程图](/img/v8-CPU.png)
- 在编写汇编代码时需要了解和处理器架构相关的硬件知识；

因此我们需要一种能屏蔽计算机架构细节的语言，比如： C++，java，Python 等，这些高级语言随之诞生了。

CPU 处理器也识别不理高级语言代码，我们一般有两种方式解决，解释执行和编译执行。

#### 解释执行

需要将源代码通过解析器编译成中间代码，之后直接使用解释器解释执行中间代码。

#### 编译执行

先将源代码转换为中间代码，然后再使用编译器将中间代码编译成二进制机器码。通常编译成的机器码是以二进制文件形式存储的，需要执行这段程序的时候直接执行二进制文件即可。

以上就是计算机执行高级语言的两种基本的方式：解释执行和编译执行。但是针对不同的高级语言，这个实现方式还是有很大差异的，比如要执行 C 语言编写的代码，你需要将其编译为二进制代码的文件，然后再直接执行二进制代码。而对于像 Java 语言、JavaScript 语言等，则需要不同虚拟机，模拟计算机的这个编译执行流程。执行 Java 语言，需要经过 Java 虚拟机的转换，执行 JavaScript 需要经过 JavaScript 虚拟机的转换。

### V8 是怎么执行 JavaScript 代码的

在 V8 之前，所有的 JavaScript 虚拟机所采用的都是解释执行的方式，这是 JavaScript 执行速度过慢的一个主要原因。
V8 混合使用了编译执行和解释执行两种手段，我们称为 JIT（Just In Time）。因为解释执行启动快，执行慢，编译执行启动慢，执行快。

当然，这个 JIT 技术也不是 V8 首创，像 Java，PHP 的虚拟机也有相关实现。

![v8执行js流程图](/img/v8执行js流程图.png)

- 在 V8 启动执行 js 之前，需要准备执行 js 时所需要的一些基础环境，包括”堆空间“，”栈空间“，”全局执行上下文“，”全局作用域“，”消息循环系统“，”内置函数“等；

- 在词法分析和语法分析后生成 AST（抽象语法树）和相关作用域，作用域中存放相关变量；
- 基于 AST 和作用域生成字节码（字节码是介于 AST 和机器码的中间代码）；
- 解释器按照顺序执行字节码，并输出执行结果（在执行过程中，如果某段代码重复多次，会被标记为热点代码，热点代码会被优化编译器编译成二进制机器码，后续再执行这段代码，就会直接执行机器码了）；
- 因为 js 不是静态语言，对象的结构和属性可以在运行时任意修改，所以在执行过程中，如果对象结构被动态修改，优化编译器就需要执行反优化，下次执行时就会回退到解释器解释执行；

### V8 采用了哪些策略提升对象属性的访问速度

JavaScript 中的对象是一组组的属性和值得集合，就像一个字典。而 V8 在实现对象存储时，并没有完全采用类似字典的非线性数据结构存储。因为非线性结构的查询效率低于线性数据结构，V8 为了提升存储和查找效率，采用了一套复杂的存储策略。

![v8执行js流程图](/img/v8-线性和非线性结构物.png)

### V8 所需的基础环境

V8 执行 JavaScript 代码时需要一个基础环境，也就是宿主。因为 V8 并不是一个完整的系统，所以在执行时，它的一部分基础环境是由宿主提供的，这包括了全局执行上下文、事件循环系统，堆空间和栈空间。除了需要宿主提供的一些基础环境之外，V8 自身会提供 JavaScript 的核心功能和垃圾回收系统。

宿主环境在启动过程中，会构造堆空间，用来存放一些对象数据，还会构造栈空间，用来存放原生数据。由于堆空间中的数据不是线性存储的，所以堆空间可以存放很多数据，但是读取的速度会比较慢，而栈空间是连续的，所以堆空间中的查找速度非常快，但是要在内存中找到一块连续的区域却显得有点难度，于是所有的程序都限制栈空间的大小，这就是我们经常容易出现栈溢出的一个主要原因。

如果在浏览器中，JavaScript 代码会频繁操作 window(this 默认指向 window 对象)、操作 dom 等内容，如果在 node 中，JavaScript 会频繁使用 global(this 默认指向 global 对象)、File API 等内容，这些内容都会在启动过程中准备好，我们把这些内容称之为全局执行上下文。

全局执行上下文中和函数的执行上下文生命周期是不同的，函数执行上下文在函数执行结束之后，就会被销毁，而全局执行上下文则和 V8 的生命周期是一致的，所以在实际项目中，如果不经常使用的变量或者数据，最好不要放到全局执行上下文中。另外，宿主环境还需要构造事件循环系统，事件循环系统主要用来处理任务的排队和任务的调度。
