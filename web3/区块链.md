## 什么是区块链

区块链，就是一个又一个区块组成的链条。每一个区块中保存了一定的信息，它们按照各自产生的时间顺序和一定规则通过 hash 连接成链条。这个链条被保存在所有的服务器中，只要整个系统中有一台服务器可以工作，整条区块链就是安全的。这些服务器在区块链系统中被称为全节点，它们为整个区块链系统提供存储空间和算力支持。如果要修改区块链中的信息，必须征得半数以上节点的同意并修改所有节点中的信息，而这些节点通常掌握在不同的主体手中，因此篡改区块链中的信息是一件极其困难的事。

基于 P2P（点对点）网络的原理，公有链技术本质上是去中心化的，这是其吸引广大公众的关键特性之一。在大多数网络中，公有链没有专用服务器，不是一个授权机构，而是用户之间的共识。

每个区块可以理解成关系型数据库的一张表，但是这张表的数据只能新增和查询，不能删除和修改，每张表之间通过一个计算出来的 hash 值互相连接形成一条链。

相比于传统的网络，区块链具有两大核心特点：一是数据难以篡改、二是去中心化。基于这两个特点，区块链所记录的信息更加真实可靠，可以帮助解决人们互不信任的问题。

### 场景演进

| 场景               | 功能     | 编程语言 | 一致性                               | 代表     |
| ------------------ | -------- | -------- | ------------------------------------ | -------- |
| 数字货币           | 记账功能 | 脚本     | POW                                  | 比特币   |
| 分布式应用引擎     | 智能合约 | 特定语言 | POW，POS                             | 以太坊   |
| 带权限的分布式账本 | 商业处理 | 高级语言 | 包括 CFT、BFT 在内的多种机制，可插拔 | 超级账本 |

### 类型

- 公有区块链：世界上任何个体或者团体都可以发送交易，且交易能够获得该区块链的有效确认，任何人都可以参与其共识过程。公有区块链是最早的区块链，也是应用最广泛的区块链，各大 bitcoins 系列的虚拟数字货币均基于公有区块链，世界上有且仅有一条该币种对应的区块链
- 行业区块链（联盟链）：由某个群体内部指定多个预选的节点为记账人，每个块的生成由所有的预选节点共同决定（预选节点参与共识过程），其他接入节点可以参与交易，但不过问记账过程（本质上还是托管记账，只是变成分布式记账，预选节点的多少，如何决定每个块的记账者成为该区块链的主要风险点），其他任何人可以通过该区块链开放的 API 进行限定查询
- 私有区块链

### 特征

- 去中心化：区块链技术不依赖额外的第三方管理机构或硬件设施，没有中心管制，除了自成一体的区块链本身，通过分布式核算和存储，各个节点实现了信息自我验证、传递和管理。去中心化是区块链最突出最本质的特征
- 开放性
- 独立性：基于协商一致的规范和协议（类似比特币采用的哈希算法等各种数学算法），整个区块链系统不依赖其他第三方，所有节点能够在系统内自动安全地验证、交换数据，不需要任何人为的干预
- 安全性：只要不能掌控全部数据节点的 51%，就无法肆意操控修改网络数据
- 匿名性：各区块节点的身份信息不需要公开或验证，信息传递可以匿名进行

### 架构模型

![架构](/img/区块链架构.png)

- 数据层：封装了底层数据区块以及相关的数据加密和时间戳等基础数据和基本算法；
- 网络层：包括分布式组网机制，数据传播机制和数据验证机制等；
- 共识层：主要封装网络节点的各类共识算法；
- 激励层：主要包括经济激励的发行机制和分配机制等；
- 合约层：主要封装各类脚本，算法和智能合约，是区块链可编程特性的基础；
- 应用层：区块链的各种应用场景和案例；

### 核心技术

#### 分布式账本

分布式账本指的是交易记账由分布在不同地方的多个节点共同完成，而且每一个节点记录的都是完整账本，因此它们都可以参与监督交易合法性。

与传统的分布式存储的不同是：

- 分布式账本每个节点都存储完整数据，分布式存储则是将数据拆分成多份存储；
- 分布式账本每个节点存储都是独立的，地位等同的，依靠共识机制保证存储一致性，分布式存储一般是通过中心节点向其他备份节点同步数据。

#### 非对称加密

#### 共识机制

共识机制就是所有记账节点之间怎么达成共识，去认定一个记录的有效性。区块链提出了不同的共识机制，适用于不同场景：

- 工作量证明机制：节点通过计算随机哈希散列的数值争夺记账权，求得正确的数值解以生成区块。因为求得正确数值在底层算法的保证下，需要节点运行大量的计算才能得出，这个计算就是工作量，比特币的挖矿就是使用的该机制。
- 权益证明机制：当创造一个新区块时，矿工需要创建一个币权交易，交易会按照比例发送币给矿工。权益证明机制根据每个节点拥有代币的比例和时间，依据算法等比例地降低节点的挖矿难度，从而加快了寻找随机数的速度。这种共识机制可以缩短达成共识所需的时间，但本质上仍然需要网络中的节点进行挖矿运算。
- ...

#### 智能合约

智能合约是基于这些可信的不可篡改的数据，可以自动化的执行一些预先定义好的规则和条款。

以保险为例，如果说每个人的信息（包括医疗信息和风险发生的信息）都是真实可信的，那就很容易的在一些标准化的保险产品中，去进行自动化的理赔。

## 区块链运作方式

区块链到底是如何运作的呢？

我们先来看一个小故事。

有一个与世隔绝的小村落，村民们经常互相借东西，比如张三给李四借了一只羊，李四承诺一个月后归还 1 只羊+1 只鸡。为了防止李四赖账，就请德高望重的老村长来作证并帮忙记个账。

后来村子越来越大，村民们相互借的东西多了，账目也越来越多，于是大家开始担心起来：

村长年纪大了眼花记错账怎么办，又怕村长家进贼账本被偷了，或者万一村长一时财迷心窍、跟人串通偷偷改账本怎么办。

最后大家开会决定，以后的账由新选出来的村长负责记好了贴在公告栏里，大家各自都抄一份放家里，不管谁家的账本丢了、修改了，以大多数人手里的为准。

这就是区块链的工作原理。在这个故事里，村里的账本是公开透明、所有人共同检查、共同持有的，账本很难记错或被偷偷篡改。

回到我们开头提到的，就算没有村长这个“中间巨头”来作证记账，村里的交易依然可以正常进行，因为任何一笔交易发生之后，所有其他村民都可以作为见证人，并且参与记账。

在区块链网络中也是类似，**在没有中介巨头担保见证的情况下，任意一笔交易发生时，区块链网络背后的算法以及激励机制吸引大量其他人来参与记账、保障交易的顺利进行，对交易双方来说，这笔交易是点对点的直接交易，不需要将资产转移到中间人账户。**

### 基本原理

首先理解三个概念：

- 交易：一次对账本的操作，导致账本的状态的一次改变，如：添加一条转账记录；
- 区块：记录一段时间内发生的所有交易和状态结果等，是对当前账本状态的一次共识；
- 链：由区块按照发生顺序串联而成，是整个账本状态变化的日志记录；

如果把区块链系统作为一个状态机，则每次交易意味着一次状态改变；生成的区块，就是参与者对其中交易导致状态改变结果的共识。

区块链的目标是实现一个分布的数据记录账本，这个账本只允许添加、不允许删除。账本底层的基本结构是一个线性的链表。链表由一个个“区块”串联组成，后继区块中记录前导区块的哈希（Hash）值。某个区块（以及块里的交易）是否合法，可通过计算哈希值的方式进行快速检验。网络中节点可以提议添加一个新的区块，但必须经过共识机制来对区块达成确认。

### 区块链节点

区块链节点简单理解，每个参与者都是一个节点。

根据不同的特征，节点分为不同的类型。以比特币为例，这里有两种类型的节点：

- 一种是存储副本链的全节点，这种节点通过验证数据来保证区块链上数据的安全性和正确性；
- 另一种节点是轻节点，即每个参与的用户，每一个轻节点需要连接到一个全节点，以便同步网络的当前状态并能参与运行；

#### 区块链节点类型

- 全节点：全节点充当网络中的服务器，他们主要任务是存储区块链副本，维护其他节点之间的共识规则及交易验证。
  - 精简节点：从头下载区块，达到设置的限制便删除最旧的区块，仅保留其区块头信息和链位置。
  - 归档节点：这是大多数人理解的全节点，主要任务是保持共识机制并验证区块，托管整个区块链。
- 矿工节点：可能是全节点或轻节点，他们存在的目的是证明该节点已完成创建区块所需的工作。区块链加密货币的参与者通过使用硬件（CPU，GPU 或 ASIC）来解决问题，每个具体任务的第一个完成者将其结果广播到网络，以便通过全节点进行验证。一旦达成共识就可以将其结果作为区块添加到现有的区块链中。矿工除了获得该区块的交易费用，还会获得一定的货币奖励，这种奖励称为创币。
- 主节点：与全节点相比，主节点本身不能向区块链添加区块，作用是保留交易记录并进行验证。通过运行主节点，不仅可以保护网络安全，还可以分享服务收益。
- 轻节点：也可以定义为“轻钱包”，它依靠全节点提供必要的信息与区块链通信，由于没有存储整个区块链，因此它们只能查询一个区块的当前状态并进行广播交易处理。
- 闪电节点：它是在区块链的外部的用户之间建立连接，以此减低网络负载，缩短传输时间，提高加密货币的可用性。闪电节点的工作方式是在实体之间搭建单独的支付渠道。以百吉饼商店和鲍勃为例：鲍勃和商店创建了一个类似保管箱（多重签名地址）的东西，他们俩都有各自的钥匙。鲍勃存入自己的资金，并用它们支付百吉饼。每笔交易均需双方同意，并且几乎是即时发生的。一旦鲍勃有足够的百吉饼或者没钱了，他或商店就可以关闭连接，获取最新的资产负债表，并将其广播到网络上。
- 权益质押节点，授权节点....

### 挖矿

挖矿是指区块链网络中的维护节点，通过协助生成和确认新区块来获取一定量新增虚拟货币的过程。

拿比特币举例，当用户向比特币网络中发布交易后，需要有人将交易进行记录和确认，形成新的区块，并串联到区块链中，在一个互相不信任的分布式系统中，该由谁来完成呢？比特币采用了“挖矿”的方式解决。

#### 挖矿机制（Proof of Work 工作证明）

POW 挖矿指的是你能获得多少货币取决于你挖矿贡献的有效工作。大部分虚拟货币，比如比特币，莱特币等都是基于 POW 模式的。

靠工作量来证明发币的好处是：矿工们会努力维护交易，谁更卖力维护，就多得币（尝试的次数越多，算出来的概率越大）。

坏处就是：没有成为第一个挖到矿的人所付出的硬件，电力，维护等成本就沉没掉了。

比如：比特币是由计算机生成的一串串复杂的代码组成，每隔 10 分钟，比特币系统就会在节点上随机生成一个数据区块，这个区块记录了 10 分钟内发生的验证过的交易数据。大量的算力去寻找此区块，谁能够第一时间找到，谁就获得这个区块对应的比特币激励奖励还有在这个区块中包含的交易的“小费”。

#### 挖矿过程

用户通过比特币客户端发起一项交易，消息广播到比特币网络中等待确认。矿工会将收到的等待确认的交易请求打包在一起，添加上前一个区块头部的哈希值等信息，组成一个区块结构。然后，试图找到一个 nonce 串（随机串）放到区块里，使得区块结构的哈希结果满足一定条件（比如小于某个值）。这个计算 nonce 串的过程，即俗称的“挖矿”。nonce 串的查找需要花费一定的计算力。

一旦矿工找到了满足条件的 nonce 串，这个区块在格式上就“合法”了，成为候选区块。节点将其在网络中广播出去。其它节点收到候选区块后进行验证，发现确实合法，就承认这个区块是一个新的合法区块，并添加到自己维护的本地区块链结构上。当大部分节点都接受了该区块后，意味着区块被网络接受，区块中所包括的交易也就得到确认。

#### 挖矿难度

挖矿难度是写在区块链里面的一种线性上升的数学机制，随着挖矿队伍扩大，获取数据区块的难度也将变大。

现在，个人挖矿已经基本不可能了，随之出现的是矿池，即很多个个体组成的一个集团，大家把算力集合起来一起挖矿，最终通过算力贡献来分配奖励。

#### 挖矿奖励

1. 区块奖励：这部分奖励属于虚拟货币的激励机制，鼓励大家挖矿，在挖矿成功后给予的激励，这个激励是会按一定规律减少的（比特币是每四年减半）；
2. 记账奖励：区块里的每笔交易都可能包含一笔交易费，这是给矿工的交易“小费”，目前这笔费用占矿工收入的 0.5%，但随着激励的减少，交易费占收入权重就会逐渐增加；

### 区块链数据

1. 每个交易发生时，都会被记录为一个数据“块”；
2. 每个块都连接到位于它前后的块；
3. 每添加一个块都会加强前一个块的验证，从而增强整条区块链；

## 应用

- 金融： 数字人民币，比特币等虚拟货币；
- 物流：通过区块链可以追溯物品生产和运输过程，并且提高供应链的管理效率；
- 数字版权
- 公益
- 保险
- 司法

## 以太坊（Ethereum）

以太坊最初目标是打造一个运行智能合约的平台，该平台支持图灵完备的应用，按照智能合约的约定逻辑自动执行。

基于以太坊项目，以太坊团队目前运营了一条公开的区块链平台——以太坊网络。智能合约开发者使用官方提供的工具和以太坊专用应用开发语言 Solidity，可以很容易开发出运行在以太坊网络上的“去中心化”应用（Decentralized Application，DApp）。这些应用将运行在以太坊的虚拟机（Ethereum Virtual Machine，EVM）里。用户通过以太币（Ether）来购买燃料（Gas），维持所部署应用的运行。

跟比特币项目相比，以太坊区块链的技术特点主要包括：

- 支持图灵完备的智能合约，设计了编程语言 Solidity 和虚拟机 EVM；
- 选用了内存需求较高的哈希函数，避免出现强算力矿机、矿池攻击；
- 叔块（Uncle Block）激励机制，降低矿池的优势，并减少区块产生间隔（10 分钟降低到 15 秒左右）；
- 采用账户系统和世界状态，而不是 UTXO，容易支持更复杂的逻辑；
- 通过 Gas 限制代码执行指令数，避免循环执行攻击；
- 支持 PoW 共识算法，并计划支持效率更高的 PoS 算法。

### 核心概念

#### 智能合约

智能合约（Smart Contract）是以太坊中最为重要的一个概念，即以计算机程序的方式来缔结和运行各种合约。

智能合约作为运行在以太坊虚拟机（Ethereum Virual Machine，EVM）中的应用，可以接受来自外部的交易请求和事件，通过触发运行提前编写好的代码逻辑，进一步生成新的交易和事件，可以进一步调用其它智能合约。
智能合约的执行结果可能对以太坊网络上的账本状态进行更新。这些修改由于经过了以太坊网络中的共识，一旦确认后无法被伪造和篡改。

#### 账户

以太坊账户分为两种类型：合约账户（Contracts Accounts）和外部账户（Externally Owned Accounts，或 EOA）。

- 合约账户：存储执行的智能合约代码，只能被外部账户来调用激活；
- 外部账户：以太币拥有者账户，对应到某公钥。账户包括 nonce、balance、storageRoot、codeHash 等字段，由个人来控制。

当合约账户被调用时，存储其中的智能合约会在矿工处的虚拟机中自动执行，并消耗一定的燃料。燃料通过外部账户中的以太币进行购买。

#### 交易

交易（Transaction），在以太坊中是指从一个账户到另一个账户的消息数据。消息数据可以是以太币或者合约执行参数。

以太坊采用交易作为执行操作的最小单位。每个交易包括如下字段：

- to：目标账户地址。
- value：可以指定转移的以太币数量。
- nonce：交易相关的字串，用于防止交易被重放。
- gasPrice：执行交易需要消耗的 Gas 价格。
- gasLimit：交易消耗的最大 Gas 值。
- data: 交易附带字节码信息，可用于创建/调用智能合约。
- signature：基于椭圆曲线加密的签名信息，包括 R，S，V 三个字段。。

类似比特币网络，在发送交易时，用户需要缴纳一定的交易费用，通过以太币方式进行支付和消耗。目前，以太坊网络可以支持超过比特币网络的交易速率（可以达到每秒几十笔）。

#### 以太币

以太币（Ether）是以太坊网络中的货币。

以太币主要用于购买燃料，支付给矿工，以维护以太坊网络运行智能合约的费用。以太币最小单位是 wei，一个以太币等于 10^18 个 wei。

以太币同样可以通过挖矿来生成。成功生成新区块的以太坊矿工可以获得 2 个以太币的奖励，以及包含在区块内的燃料费用和发现叔块(Uncle block)获得的奖励。用户也可以通过交易市场来直接购买以太币。

目前每年大约可以通过挖矿生成超过一千万个以太币。

#### 燃料

燃料（Gas），控制某次交易执行指令的上限。每执行一条合约指令会消耗固定的燃料。当某个交易还未执行结束，而燃料消耗完时，合约执行终止并回滚状态。

Gas 可以跟以太币进行兑换。需要注意的是，以太币的价格是波动的，但运行某段智能合约的燃料费用可以是固定的，通过设定 Gas 价格等进行调节。
